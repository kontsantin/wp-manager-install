#!/bin/bash
# ================================
# WordPress Manager ั Docker
# ะะฝัะตัะฐะบัะธะฒะฝะพะต ัะฟัะฐะฒะปะตะฝะธะต ะฟัะพะตะบัะฐะผะธ
# ================================

set -e

WWW_PATH="$HOME/www"
PROJECTS_FILE="$HOME/.wp-projects.txt"

# ะฆะฒะตัะฐ ะดะปั ะฒัะฒะพะดะฐ
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ะคัะฝะบัะธั ะฒัะฒะพะดะฐ ะทะฐะณะพะปะพะฒะบะฐ
print_header() {
    echo -e "${BLUE}================================${NC}"
    echo -e "${BLUE}  WordPress Manager${NC}"
    echo -e "${BLUE}================================${NC}"
    echo ""
}

# ะคัะฝะบัะธั ะฒัะฑะพัะฐ ะฟัะพะตะบัะฐ ะธะท ัะฟะธัะบะฐ
select_project() {
    local filter_type="$1"  # all, running, stopped
    local projects=()
    local domains=()
    local ports=()
    local paths=()
    
    if [[ ! -f "$PROJECTS_FILE" ]] || [[ ! -s "$PROJECTS_FILE" ]]; then
        echo -e "${YELLOW}โน ะะตั ัะพะทะดะฐะฝะฝัั ะฟัะพะตะบัะพะฒ${NC}"
        return 1
    fi
    
    # ะกะพะฑะธัะฐะตะผ ะฟัะพะตะบัั ะฒ ะทะฐะฒะธัะธะผะพััะธ ะพั ัะธะปัััะฐ
    while IFS='|' read -r name domain port path; do
        if [[ -d "$path" ]]; then
            local add_project=0
            
            if [[ "$filter_type" == "all" ]]; then
                add_project=1
            elif [[ "$filter_type" == "running" ]]; then
                if docker ps --format '{{.Names}}' | grep -q "^${name}_wp$"; then
                    add_project=1
                fi
            elif [[ "$filter_type" == "stopped" ]]; then
                if docker ps -a --format '{{.Names}}' | grep -q "^${name}_wp$" && ! docker ps --format '{{.Names}}' | grep -q "^${name}_wp$"; then
                    add_project=1
                fi
            fi
            
            if [[ $add_project -eq 1 ]]; then
                projects+=("$name")
                domains+=("$domain")
                ports+=("$port")
                paths+=("$path")
            fi
        fi
    done < "$PROJECTS_FILE"
    
    if [[ ${#projects[@]} -eq 0 ]]; then
        if [[ "$filter_type" == "running" ]]; then
            echo -e "${YELLOW}โน ะะตั ะทะฐะฟััะตะฝะฝัั ะฟัะพะตะบัะพะฒ${NC}"
        elif [[ "$filter_type" == "stopped" ]]; then
            echo -e "${YELLOW}โน ะะตั ะพััะฐะฝะพะฒะปะตะฝะฝัั ะฟัะพะตะบัะพะฒ${NC}"
        else
            echo -e "${YELLOW}โน ะะตั ะฟัะพะตะบัะพะฒ${NC}"
        fi
        return 1
    fi
    
    echo -e "${BLUE}ะัะฑะตัะธัะต ะฟัะพะตะบั:${NC}"
    echo ""
    
    local i=1
    for name in "${projects[@]}"; do
        local idx=$((i-1))
        echo -e "  ${GREEN}${i})${NC} ${name} (${domains[$idx]})"
        ((i++))
    done
    echo ""
    echo -e "  ${YELLOW}0)${NC} ะัะผะตะฝะฐ"
    echo ""
    
    read -p "ะะฐั ะฒัะฑะพั: " choice
    
    if [[ "$choice" == "0" ]]; then
        echo -e "${YELLOW}โน ะัะผะตะฝะตะฝะพ${NC}"
        return 1
    fi
    
    if [[ "$choice" =~ ^[0-9]+$ ]] && [[ $choice -ge 1 ]] && [[ $choice -le ${#projects[@]} ]]; then
        local idx=$((choice-1))
        SELECTED_PROJECT="${projects[$idx]}"
        SELECTED_DOMAIN="${domains[$idx]}"
        SELECTED_PORT="${ports[$idx]}"
        SELECTED_PATH="${paths[$idx]}"
        return 0
    else
        echo -e "${RED}โ ะะตะฒะตัะฝัะน ะฒัะฑะพั${NC}"
        return 1
    fi
}

# ะคัะฝะบัะธั ะฟะพะปััะตะฝะธั ัะฒะพะฑะพะดะฝะพะณะพ ะฟะพััะฐ
get_free_port() {
    local port=80
    
    # ะัะพะฒะตััะตะผ ะฟะพััั ะฝะฐัะธะฝะฐั ั 80
    while true; do
        # ะัะพะฒะตััะตะผ ัะตัะตะท Docker - ะฝะต ะทะฐะฝัั ะปะธ ะฟะพัั ะบะพะฝัะตะนะฝะตัะพะผ
        if docker ps --format '{{.Ports}}' | grep -q "0.0.0.0:${port}->"; then
            ((port++))
            continue
        fi
        
        # ะัะพะฒะตััะตะผ ัะตัะตะท netstat - ะฝะต ะทะฐะฝัั ะปะธ ะฟะพัั ัะธััะตะผะพะน
        if netstat -tuln 2>/dev/null | grep -q ":${port} "; then
            ((port++))
            continue
        fi
        
        # ะะพัั ัะฒะพะฑะพะดะตะฝ
        echo "$port"
        return
    done
}

# ะคัะฝะบัะธั ัะพะทะดะฐะฝะธั ะฝะพะฒะพะณะพ ะฟัะพะตะบัะฐ
create_project() {
    echo -e "${GREEN}โถ ะกะพะทะดะฐะฝะธะต ะฝะพะฒะพะณะพ WordPress ะฟัะพะตะบัะฐ${NC}"
    echo ""
    
    read -p "ะะฒะตะดะธัะต ะฝะฐะทะฒะฐะฝะธะต ัะตะผั/ะฟัะพะตะบัะฐ (ะฟัะธะผะตั: my-site): " THEME_NAME
    if [[ -z "$THEME_NAME" ]]; then
        echo -e "${RED}โ ะะฐะทะฒะฐะฝะธะต ะฝะต ะผะพะถะตั ะฑััั ะฟััััะผ${NC}"
        return 1
    fi
    
    # ะะพัะผะฐะปะธะทัะตะผ ะฒะฒะพะด ะธะผะตะฝะธ ัะตะผั:
    # - ัะดะฐะปัะตะผ/ะทะฐะผะตัะฐะตะผ ะฝะตะบะพััะตะบัะฝัะต/ะฝะตะฒะธะดะธะผัะต ัะธะผะฒะพะปั
    # - ะพะฑัะตะทะฐะตะผ ะฟัะพะฑะตะปั ะฟะพ ะบัะฐัะผ
    # - ะทะฐะผะตะฝัะตะผ ะปัะฑัะต ะฟัะพะฑะตะปัะฝัะต ะณััะฟะฟั ะฝะฐ ะดะตัะธั
    # - ะพััะฐะฒะปัะตะผ ัะพะปัะบะพ ะปะฐัะธะฝัะบะธะต ะฑัะบะฒั, ัะธััั, ะดะตัะธั ะธ ะฟะพะดัััะบะธะฒะฐะฝะธะต
    # - ะฟัะธะฒะพะดะธะผ ะบ ะฝะธะถะฝะตะผั ัะตะณะธัััั
    # - ััะปะพะฟัะฒะฐะตะผ ะฟะพะฒัะพััััะธะตัั ะดะตัะธัั/ะฟะพะดัััะบะธะฒะฐะฝะธั ะธ ัะฑะธัะฐะตะผ ะบัะฐะตะฒัะต
    THEME_NAME=$(echo "$THEME_NAME" | { iconv -f UTF-8 -t UTF-8 -c 2>/dev/null || cat; } )
    THEME_NAME=$(echo "$THEME_NAME" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
    THEME_NAME=$(echo "$THEME_NAME" | sed 's/[[:space:]]\+/-/g')
    THEME_NAME=$(echo "$THEME_NAME" | sed 's/[^a-zA-Z0-9_-]//g' | tr '[:upper:]' '[:lower:]')
    THEME_NAME=$(echo "$THEME_NAME" | sed 's/[-_]\+/-/g' | sed 's/^-//' | sed 's/-$//')
    # ะัะปะธ ะฝะฐัะฐะปะพ ะธะผะตะฝะธ ัะธััะฐ โ ะดะพะฑะฐะฒะปัะตะผ ะฟัะตัะธะบั
    if [[ $THEME_NAME =~ ^[0-9] ]]; then
        THEME_NAME="t_${THEME_NAME}"
    fi
    
    if [[ -z "$THEME_NAME" ]]; then
        echo -e "${RED}โ ะะฐะทะฒะฐะฝะธะต ะดะพะปะถะฝะพ ัะพะดะตัะถะฐัั ัะพะปัะบะพ ะปะฐัะธะฝัะบะธะต ะฑัะบะฒั, ัะธััั, ะดะตัะธั ะธะปะธ ะฟะพะดัััะบะธะฒะฐะฝะธะต${NC}"
        return 1
    fi
    
    echo -e "${BLUE}โน ะัะฟะพะปัะทัะตััั ะฝะฐะทะฒะฐะฝะธะต: ${THEME_NAME}${NC}"
    
    read -p "ะะฒะตะดะธัะต ะดะพะผะตะฝ (ะฟัะธะผะตั: my-site.local): " DOMAIN
    if [[ -z "$DOMAIN" ]]; then
        DOMAIN="${THEME_NAME}.local"
        echo -e "${YELLOW}โน ะัะฟะพะปัะทัะตััั ะดะพะผะตะฝ: ${DOMAIN}${NC}"
    fi
    
    WP_PATH="${WWW_PATH}/${THEME_NAME}"
    
    if [[ -d "$WP_PATH" ]]; then
        echo -e "${RED}โ ะัะพะตะบั '${THEME_NAME}' ัะถะต ัััะตััะฒัะตั ะฒ ${WP_PATH}${NC}"
        return 1
    fi
    
    # ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะฒัะต ะทะฐะฟััะตะฝะฝัะต ะฟัะพะตะบัั
    echo ""
    echo -e "${YELLOW}๐ ะััะฐะฝะฐะฒะปะธะฒะฐั ะฒัะต ะทะฐะฟััะตะฝะฝัะต ะฟัะพะตะบัั...${NC}"
    
    if [[ -f "$PROJECTS_FILE" ]]; then
        while IFS='|' read -r name domain port path; do
            if [[ -d "$path" ]] && docker ps --format '{{.Names}}' | grep -q "^${name}_wp$"; then
                echo -e "   ะััะฐะฝะฐะฒะปะธะฒะฐั ${name}..."
                cd "$path" && docker compose stop 2>/dev/null
            fi
        done < "$PROJECTS_FILE"
    fi
    
    echo ""
    echo -e "${BLUE}๐ฆ ะกะพะทะดะฐั ััััะบัััั ะฟัะพะตะบัะฐ...${NC}"
    mkdir -p "$WP_PATH/wp-content/themes"
    mkdir -p "$WP_PATH/wp-content/plugins"
    mkdir -p "$WP_PATH/wp-content/uploads"
    
    # ะะตะฝะตัะฐัะธั ัะปััะฐะนะฝะพะณะพ ะฟะฐัะพะปั
    DB_PASS=$(openssl rand -base64 16 | tr -d "=+/" | cut -c1-16)
    SAFE_DB_NAME=$(echo "$THEME_NAME" | tr '-' '_' | tr '[:upper:]' '[:lower:]')
    DB_NAME="wp_${SAFE_DB_NAME}"
    DB_USER="${SAFE_DB_NAME}_user"
    
    # ะะพะปััะฐะตะผ ัะฒะพะฑะพะดะฝัะน ะฟะพัั
    PORT=$(get_free_port)
    
    echo -e "${BLUE}๐ณ ะกะพะทะดะฐั docker-compose.yml...${NC}"
    
    # ะกะพะทะดะฐะฝะธะต docker-compose.yml
    cat > "$WP_PATH/docker-compose.yml" <<'YAML'
version: '3.8'

services:
  db:
    image: mariadb:10.6
    container_name: PROJECTNAME_db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: DBPASS
      MYSQL_DATABASE: DBNAME
      MYSQL_USER: DBUSER
      MYSQL_PASSWORD: DBPASS
    volumes:
      - db_data:/var/lib/mysql
    networks:
      - wp_network

  wordpress:
    image: wordpress:php8.1-apache
    container_name: PROJECTNAME_wp
    restart: unless-stopped
    depends_on:
      - db
    ports:
      - "PORTNUM:80"
    environment:
      WORDPRESS_DB_HOST: db:3306
      WORDPRESS_DB_USER: DBUSER
      WORDPRESS_DB_PASSWORD: DBPASS
      WORDPRESS_DB_NAME: DBNAME
      WORDPRESS_TABLE_PREFIX: wp_
      WORDPRESS_DEBUG: 1
    volumes:
      - ./wp-content:/var/www/html/wp-content
    networks:
      - wp_network

volumes:
  db_data:

networks:
  wp_network:
    driver: bridge
YAML

    # ะะฐะผะตะฝัะตะผ ะฟะปะตะนััะพะปะดะตัั
    sed -i "s/PROJECTNAME/${THEME_NAME}/g" "$WP_PATH/docker-compose.yml"
    sed -i "s/DBPASS/${DB_PASS}/g" "$WP_PATH/docker-compose.yml"
    sed -i "s/DBNAME/${DB_NAME}/g" "$WP_PATH/docker-compose.yml"
    sed -i "s/DBUSER/${DB_USER}/g" "$WP_PATH/docker-compose.yml"
    sed -i "s/PORTNUM/${PORT}/g" "$WP_PATH/docker-compose.yml"

    # ะกะพััะฐะฝัะตะผ ะธะฝัะพัะผะฐัะธั ะพ ะฟัะพะตะบัะต
    cat > "$WP_PATH/.project-info" <<INFO
PROJECT_NAME=${THEME_NAME}
DOMAIN=${DOMAIN}
PORT=${PORT}
DB_NAME=${DB_NAME}
DB_USER=${DB_USER}
DB_PASS=${DB_PASS}
CREATED=$(date '+%Y-%m-%d %H:%M:%S')
INFO

    # ะกะบะฐัะธะฒะฐะตะผ WordPress
    echo -e "${BLUE}๐ฅ ะกะบะฐัะธะฒะฐั WordPress...${NC}"
    wget -q https://wordpress.org/latest.tar.gz -O /tmp/wp.tar.gz
    if [[ $? -ne 0 ]]; then
        echo -e "${RED}โ ะะต ัะดะฐะปะพัั ัะบะฐัะฐัั WordPress${NC}"
        return 1
    fi
    
    # ะะฐัะฟะฐะบะพะฒัะฒะฐะตะผ WordPress
    echo -e "${BLUE}๐ฆ ะะฐัะฟะฐะบะพะฒัะฒะฐั WordPress...${NC}"
    tar -xzf /tmp/wp.tar.gz -C "$WP_PATH" --strip-components=1
    if [[ $? -ne 0 ]]; then
        echo -e "${RED}โ ะะต ัะดะฐะปะพัั ัะฐัะฟะฐะบะพะฒะฐัั WordPress${NC}"
        return 1
    fi
    
    # ะฃะดะฐะปัะตะผ wp-content ะธะท ัะฐัะฟะฐะบะพะฒะฐะฝะฝะพะณะพ, ััะพะฑั ะผะพะฝัะธัะพะฒะฐะปัั ะปะพะบะฐะปัะฝัะน
    rm -rf "$WP_PATH/wp-content"

    # ะกะพะทะดะฐัะผ ะฑะฐะทะพะฒัั ัะตะผั ัะตัะตะท ะฒะฝะตัะฝะธะน ัะฐะฑะปะพะฝะฝัะน ัะบัะธะฟั (ะตัะปะธ ะตััั)
    THEME_DIR="$WP_PATH/wp-content/themes/$THEME_NAME"
    if [[ -f "/usr/local/bin/theme-template.sh" ]]; then
        # ะฟะพะดะบะปััะฐะตะผ ะธ ะฒัะทัะฒะฐะตะผ ััะฝะบัะธั ัะพะทะดะฐะฝะธั ัะตะผั
        source /usr/local/bin/theme-template.sh
        create_theme_files "$THEME_DIR" "$THEME_NAME" "$WP_PATH" || true
    else
        mkdir -p "$THEME_DIR"
    fi

    # ะะพะฑะฐะฒะปัะตะผ ะฒ ัะฟะธัะพะบ ะฟัะพะตะบัะพะฒ (ั ะฟัะฐะฒะธะปัะฝะพะน ะบะพะดะธัะพะฒะบะพะน UTF-8)
    printf "%s|%s|%s|%s\n" "${THEME_NAME}" "${DOMAIN}" "${PORT}" "${WP_PATH}" >> "$PROJECTS_FILE"
    
    echo -e "${BLUE}๐ ะะฐะฟััะบะฐั Docker ะบะพะฝัะตะนะฝะตัั...${NC}"
    
    # ะะฐะฟััะบ docker-compose
    cd "$WP_PATH"
    if command -v docker >/dev/null && docker compose version >/dev/null 2>&1; then
        docker compose up -d
    elif command -v docker-compose >/dev/null; then
        docker-compose up -d
    else
        echo -e "${RED}โ Docker compose ะฝะต ะฝะฐะนะดะตะฝ. ะฃััะฐะฝะพะฒะธัะต Docker Desktop.${NC}"
        return 1
    fi
    
    # ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะฟัะฐะฒะฐ ะฝะฐ ะฟะฐะฟะบั ะฟัะพะตะบัะฐ ะดะปั ัะตะดะฐะบัะธัะพะฒะฐะฝะธั
    echo -e "${BLUE}๐ง ะฃััะฐะฝะฐะฒะปะธะฒะฐั ะฟัะฐะฒะฐ ะฝะฐ ัะฐะนะปั...${NC}"
    sudo chown -R "$USER:$USER" "$WP_PATH"
    chmod -R 755 "$WP_PATH"
    
    # ะะฐัััะพะนะบะฐ ะดะพะผะตะฝะฐ ะฒ /etc/hosts (WSL)
    echo -e "${BLUE}๐ง ะะฐัััะฐะธะฒะฐั ะปะพะบะฐะปัะฝัะน ะดะพะผะตะฝ...${NC}"
    
    # ะัะพะฒะตััะตะผ, ะตััั ะปะธ ัะถะต ะทะฐะฟะธัั ะฒ hosts
    if ! grep -q "127.0.0.1.*${DOMAIN}" /etc/hosts 2>/dev/null; then
        echo "127.0.0.1 ${DOMAIN}" | sudo tee -a /etc/hosts >/dev/null
        echo -e "${GREEN}โ ะะพะผะตะฝ ${DOMAIN} ะดะพะฑะฐะฒะปะตะฝ ะฒ /etc/hosts (WSL)${NC}"
    else
        echo -e "${YELLOW}โน ะะพะผะตะฝ ${DOMAIN} ัะถะต ะตััั ะฒ /etc/hosts (WSL)${NC}"
    fi
    
    # ะะพะฑะฐะฒะปัะตะผ ะดะพะผะตะฝ ะฒ Windows hosts ัะฐะนะป ะฐะฒัะพะผะฐัะธัะตัะบะธ
    WIN_HOSTS="/mnt/c/Windows/System32/drivers/etc/hosts"
    
    if [[ -f "$WIN_HOSTS" ]]; then
        if ! grep -q "127.0.0.1.*${DOMAIN}" "$WIN_HOSTS" 2>/dev/null; then
            echo ""
            echo -e "${YELLOW}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
            echo -e "${BLUE}๐ง ะะพะฑะฐะฒะปัั ะดะพะผะตะฝ ${DOMAIN} ะฒ Windows hosts...${NC}"
            echo -e "${YELLOW}ะกะตะนัะฐั ะฟะพัะฒะธััั ะพะบะฝะพ UAC - ะฝะฐะถะผะธัะต 'ะะฐ'${NC}"
            echo -e "${YELLOW}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
            sleep 2
            
            # ะััะฐะตะผัั ะดะพะฑะฐะฒะธัั ัะตัะตะท PowerShell ั ะฟัะฐะฒะฐะผะธ ะฐะดะผะธะฝะธัััะฐัะพัะฐ
            if powershell.exe -Command "Start-Process powershell -Verb RunAs -ArgumentList '-NoProfile -Command \"Add-Content C:\\Windows\\System32\\drivers\\etc\\hosts ''127.0.0.1 ${DOMAIN}''\"' -Wait" 2>/dev/null; then
                echo -e "${GREEN}โ ะะพะผะตะฝ ${DOMAIN} ะดะพะฑะฐะฒะปะตะฝ ะฒ Windows hosts${NC}"
            else
                echo -e "${YELLOW}โ ะะต ัะดะฐะปะพัั ะดะพะฑะฐะฒะธัั ะฐะฒัะพะผะฐัะธัะตัะบะธ${NC}"
                echo -e "${BLUE}ะัะฟะพะปะฝะธัะต ะฒัััะฝัั ะฒ PowerShell ะพั ะฐะดะผะธะฝะธัััะฐัะพัะฐ:${NC}"
                echo -e "   ${GREEN}Add-Content C:\\Windows\\System32\\drivers\\etc\\hosts '127.0.0.1 ${DOMAIN}'${NC}"
            fi
        else
            echo -e "${GREEN}โ ะะพะผะตะฝ ${DOMAIN} ัะถะต ะตััั ะฒ Windows hosts${NC}"
        fi
    fi
    
    echo ""
    echo -e "${GREEN}โ ะัะพะตะบั ััะฟะตัะฝะพ ัะพะทะดะฐะฝ!${NC}"
    echo ""
    echo -e "${YELLOW}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo -e "${GREEN}๐ ะะฝัะพัะผะฐัะธั ะพ ะฟัะพะตะบัะต:${NC}"
    echo -e "${YELLOW}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo -e "  ะัะพะตะบั:     ${THEME_NAME}"
    echo -e "  ะะพะผะตะฝ:      ${DOMAIN}"
    echo -e "  ะััั:       ${WP_PATH}"
    echo -e ""
    echo -e "${GREEN}๐ ะะพัััะฟ ะบ ัะฐะนัั:${NC}"
    if [[ "$PORT" == "80" ]]; then
        echo -e "  ะะพ ะดะพะผะตะฝั:     ${GREEN}http://${DOMAIN}${NC}"
        echo -e "  ะะพ IP:         http://localhost"
    else
        echo -e "  ะะพ ะดะพะผะตะฝั:     ${GREEN}http://${DOMAIN}:${PORT}${NC}"
        echo -e "  ะะพ IP:         http://localhost:${PORT}"
    fi
    echo -e ""
    echo -e "${GREEN}๐ ะะฐะทะฐ ะดะฐะฝะฝัั:${NC}"
    echo -e "  ะะ:         ${DB_NAME}"
    echo -e "  ะฎะทะตั:       ${DB_USER}"
    echo -e "  ะะฐัะพะปั:     ${DB_PASS}"
    echo -e ""
    if [[ "$PORT" == "80" ]]; then
        echo -e "${BLUE}๐ก ะัะบัะพะนัะต ${GREEN}http://${DOMAIN}${BLUE} ะฒ ะฑัะฐัะทะตัะต Windows${NC}"
    else
        echo -e "${BLUE}๐ก ะัะบัะพะนัะต ${GREEN}http://${DOMAIN}:${PORT}${BLUE} ะฒ ะฑัะฐัะทะตัะต Windows${NC}"
    fi
    echo -e "${BLUE}   ะธ ะฟัะพะนะดะธัะต ัััะฐะฝะพะฒะบั WordPress${NC}"
    echo -e "${YELLOW}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo ""
}

# ะคัะฝะบัะธั ัะฟะธัะบะฐ ะฟัะพะตะบัะพะฒ
list_projects() {
    echo -e "${GREEN}โถ ะกะฟะธัะพะบ ะฟัะพะตะบัะพะฒ${NC}"
    echo ""
    
    if [[ ! -f "$PROJECTS_FILE" ]] || [[ ! -s "$PROJECTS_FILE" ]]; then
        echo -e "${YELLOW}โน ะะตั ัะพะทะดะฐะฝะฝัั ะฟัะพะตะบัะพะฒ${NC}"
        return
    fi
    
    echo -e "${YELLOW}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    printf "%-20s %-25s %-10s %s\n" "ะะะะะะข" "ะะะะะ" "ะะะะข" "ะกะขะะขะฃะก"
    echo -e "${YELLOW}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    
    while IFS='|' read -r name domain port path; do
        if [[ -d "$path" ]]; then
            # ะัะพะฒะตััะตะผ ััะฐััั ะบะพะฝัะตะนะฝะตัะฐ
            if docker ps --format '{{.Names}}' | grep -q "^${name}_wp$"; then
                status="${GREEN}โ${NC} Running"
            elif docker ps -a --format '{{.Names}}' | grep -q "^${name}_wp$"; then
                status="${YELLOW}โ${NC} Stopped"
            else
                status="${RED}โ${NC} Not found"
            fi
            printf "%-20s %-25s %-10s %b\n" "$name" "$domain" "$port" "$status"
        fi
    done < "$PROJECTS_FILE"
    
    echo -e "${YELLOW}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo ""
}

# ะคัะฝะบัะธั ะพััะฐะฝะพะฒะบะธ ะฟัะพะตะบัะฐ
stop_project() {
    echo -e "${YELLOW}โถ ะััะฐะฝะพะฒะบะฐ ะฟัะพะตะบัะฐ${NC}"
    echo ""
    
    if ! select_project "running"; then
        return
    fi
    
    cd "$SELECTED_PATH"
    
    if command -v docker >/dev/null && docker compose version >/dev/null 2>&1; then
        docker compose stop
    elif command -v docker-compose >/dev/null; then
        docker-compose stop
    fi
    
    echo ""
    echo -e "${GREEN}โ ะัะพะตะบั '${SELECTED_PROJECT}' ะพััะฐะฝะพะฒะปะตะฝ${NC}"
}

# ะคัะฝะบัะธั ะทะฐะฟััะบะฐ ะฟัะพะตะบัะฐ
start_project() {
    echo -e "${GREEN}โถ ะะฐะฟััะบ ะฟัะพะตะบัะฐ${NC}"
    echo ""
    
    if ! select_project "stopped"; then
        return
    fi
    
    cd "$SELECTED_PATH"
    
    if command -v docker >/dev/null && docker compose version >/dev/null 2>&1; then
        docker compose start
    elif command -v docker-compose >/dev/null; then
        docker-compose start
    fi
    
    echo ""
    echo -e "${GREEN}โ ะัะพะตะบั '${SELECTED_PROJECT}' ะทะฐะฟััะตะฝ${NC}"
    if [[ "$SELECTED_PORT" == "80" ]]; then
        echo -e "${BLUE}๐ ะะพัััะฟ: http://${SELECTED_DOMAIN}${NC}"
    else
        echo -e "${BLUE}๐ ะะพัััะฟ: http://${SELECTED_DOMAIN}:${SELECTED_PORT}${NC}"
    fi
}

# ะคัะฝะบัะธั ะพัะบัััะธั ะฟัะพะตะบัะฐ ะฒ VS Code
open_in_vscode() {
    echo -e "${BLUE}โถ ะัะบัััั ะฟัะพะตะบั ะฒ VS Code${NC}"
    echo ""
    
    if ! select_project "all"; then
        return
    fi
    
    echo ""
    echo -e "${BLUE}ะัะฑะตัะธัะต, ััะพ ะพัะบัััั:${NC}"
    echo ""
    echo "  1) ะะตัั ัะฐะนั (ะฒัะต ะธััะพะดะฝะธะบะธ WordPress)"
    echo "  2) ะขะพะปัะบะพ wp-content (ัะตะผั, ะฟะปะฐะณะธะฝั, ะทะฐะณััะทะบะธ)"
    echo "  3) ะขะพะปัะบะพ ัะตะผะฐ ะฟัะพะตะบัะฐ"
    echo ""
    read -p "ะะฐั ะฒัะฑะพั (1, 2 ะธะปะธ 3): " open_choice
    
    case $open_choice in
        1)
            open_path="$SELECTED_PATH"
            ;;
        2)
            if [[ -d "$SELECTED_PATH/wp-content" ]]; then
                open_path="$SELECTED_PATH/wp-content"
            else
                echo -e "${YELLOW}โ wp-content ะฝะต ะฝะฐะนะดะตะฝ, ะพัะบััะฒะฐั ะฒะตัั ัะฐะนั${NC}"
                open_path="$SELECTED_PATH"
            fi
            ;;
        3)
            theme_path="$SELECTED_PATH/wp-content/themes/$SELECTED_PROJECT"
            if [[ -d "$theme_path" ]]; then
                open_path="$theme_path"
            else
                echo -e "${YELLOW}โ ะขะตะผะฐ '$SELECTED_PROJECT' ะฝะต ะฝะฐะนะดะตะฝะฐ, ะพัะบััะฒะฐั wp-content${NC}"
                open_path="$SELECTED_PATH/wp-content"
            fi
            ;;
        *)
            echo -e "${YELLOW}โน ะัะฑัะฐะฝ ะฒะตัั ัะฐะนั${NC}"
            open_path="$SELECTED_PATH"
            ;;
    esac
    
    echo ""
    echo -e "${BLUE}๐ ะัะบััะฒะฐั ${open_path} ะฒ VS Code...${NC}"
    
    # ะััะฐะตะผัั ะพัะบัััั ัะตัะตะท code ะฒ WSL (ะฟัะตะดะฟะพััะธัะตะปัะฝะพ)
    if command -v code >/dev/null 2>&1; then
        cd "$open_path" && code . >/dev/null 2>&1
        if [[ $? -eq 0 ]]; then
            echo -e "${GREEN}โ VS Code ะทะฐะฟััะตะฝ${NC}"
            echo -e "${BLUE}   ะะฐะฟะบะฐ: ${open_path}${NC}"
            return
        else
            echo -e "${YELLOW}โ ะะต ัะดะฐะปะพัั ะพัะบัััั ัะตัะตะท WSL code, ะฟัะพะฑัั ัะตัะตะท Windows...${NC}"
        fi
    fi
    
    # Fallback: ัะตัะตะท PowerShell ะธะท Windows
    local wsl_distro=$(lsb_release -si 2>/dev/null || echo "Ubuntu")
    local win_path=$(wslpath -w "$open_path" 2>/dev/null || echo "\\\\wsl.localhost\\${wsl_distro}${open_path}")
    
    if command -v powershell.exe >/dev/null 2>&1; then
        powershell.exe -Command "code '${win_path}'" >/dev/null 2>&1
        if [[ $? -eq 0 ]]; then
            echo -e "${GREEN}โ VS Code ะทะฐะฟััะตะฝ${NC}"
            echo -e "${BLUE}   ะะฐะฟะบะฐ: ${win_path}${NC}"
        else
            echo -e "${RED}โ ะะต ัะดะฐะปะพัั ะพัะบัััั VS Code ัะตัะตะท PowerShell${NC}"
            echo -e "${YELLOW}ะะพะฟัะพะฑัะนัะต ะพัะบัััั ะฒัััะฝัั: ${win_path}${NC}"
        fi
    else
        echo -e "${RED}โ PowerShell ะฝะต ะฝะฐะนะดะตะฝ${NC}"
        echo -e "${YELLOW}ะัะบัะพะนัะต ะฒัััะฝัั: ${win_path}${NC}"
    fi
}

# ะคัะฝะบัะธั ะพัะบัััะธั ัะฐะนัะฐ ะฒ ะฑัะฐัะทะตัะต
open_in_browser() {
    echo -e "${BLUE}โถ ะัะบัััั ัะฐะนั ะฒ ะฑัะฐัะทะตัะต${NC}"
    echo ""
    
    if ! select_project "running"; then
        return
    fi
    
    if [[ "$SELECTED_PORT" == "80" ]]; then
        URL="http://${SELECTED_DOMAIN}"
    else
        URL="http://${SELECTED_DOMAIN}:${SELECTED_PORT}"
    fi
    
    echo ""
    echo -e "${BLUE}๐ ะัะบััะฒะฐั ${URL}...${NC}"
    
    # ะััะฐะตะผัั ะพัะบัััั ะฒ Windows ะฑัะฐัะทะตัะต
    if command -v powershell.exe >/dev/null 2>&1; then
        powershell.exe -Command "Start-Process '${URL}'" 2>/dev/null &
        echo -e "${GREEN}โ ะัะฐัะทะตั ะทะฐะฟััะตะฝ${NC}"
    elif command -v cmd.exe >/dev/null 2>&1; then
        cmd.exe /c start "${URL}" 2>/dev/null &
        echo -e "${GREEN}โ ะัะฐัะทะตั ะทะฐะฟััะตะฝ${NC}"
    else
        echo -e "${YELLOW}โ ะะต ัะดะฐะปะพัั ะพัะบัััั ะฑัะฐัะทะตั ะฐะฒัะพะผะฐัะธัะตัะบะธ${NC}"
        echo -e "${BLUE}ะัะบัะพะนัะต ะฒัััะฝัั: ${GREEN}${URL}${NC}"
    fi
}

# ะคัะฝะบัะธั ัะดะฐะปะตะฝะธั ะฟัะพะตะบัะฐ
remove_project() {
    echo -e "${RED}โถ ะฃะดะฐะปะตะฝะธะต ะฟัะพะตะบัะฐ${NC}"
    echo ""
    
    if ! select_project "all"; then
        return
    fi
    
    echo ""
    echo -e "${YELLOW}โ ะะฝะธะผะฐะฝะธะต! ะญัะพ ัะดะฐะปะธั ะฒัะต ัะฐะนะปั ะธ ะฑะฐะทั ะดะฐะฝะฝัั ะฟัะพะตะบัะฐ '${SELECTED_PROJECT}'.${NC}"
    read -p "ะั ัะฒะตัะตะฝั? ะะฒะตะดะธัะต 'yes' ะดะปั ะฟะพะดัะฒะตัะถะดะตะฝะธั: " CONFIRM
    
    if [[ "$CONFIRM" != "yes" ]]; then
        echo -e "${BLUE}โน ะัะผะตะฝะตะฝะพ${NC}"
        return 0
    fi
    
    echo ""
    echo -e "${BLUE}๐ ะฃะดะฐะปัั ะฟัะพะตะบั...${NC}"
    
    cd "$SELECTED_PATH"
    
    # ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะธ ัะดะฐะปัะตะผ ะบะพะฝัะตะนะฝะตัั
    if command -v docker >/dev/null && docker compose version >/dev/null 2>&1; then
        docker compose down -v 2>/dev/null || true
    elif command -v docker-compose >/dev/null; then
        docker-compose down -v 2>/dev/null || true
    fi
    
    # ะฃะดะฐะปัะตะผ ะฟะฐะฟะบั ะฟัะพะตะบัะฐ (ั sudo, ั.ะบ. Docker ัะพะทะดะฐัั ัะฐะนะปั ะพั root)
    cd "$HOME"
    sudo rm -rf "$SELECTED_PATH"
    
    # ะฃะดะฐะปัะตะผ ะธะท ัะฟะธัะบะฐ ะฟัะพะตะบัะพะฒ
    if [[ -f "$PROJECTS_FILE" ]]; then
        sed -i "/^${SELECTED_PROJECT}|/d" "$PROJECTS_FILE"
    fi
    
    # ะฃะดะฐะปัะตะผ ะธะท /etc/hosts (WSL)
    if grep -q "127.0.0.1.*${SELECTED_DOMAIN}" /etc/hosts 2>/dev/null; then
        sudo sed -i "/127.0.0.1.*${SELECTED_DOMAIN}/d" /etc/hosts 2>/dev/null || true
    fi
    
    # ะฃะดะฐะปัะตะผ ะดะพะผะตะฝ ะธะท Windows hosts ัะฐะนะปะฐ ะฐะฒัะพะผะฐัะธัะตัะบะธ
    WIN_HOSTS="/mnt/c/Windows/System32/drivers/etc/hosts"
    
    if [[ -f "$WIN_HOSTS" ]]; then
        if grep -q "127.0.0.1.*${SELECTED_DOMAIN}" "$WIN_HOSTS" 2>/dev/null; then
            echo ""
            echo -e "${YELLOW}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
            echo -e "${BLUE}๐ง ะฃะดะฐะปัั ะดะพะผะตะฝ ${SELECTED_DOMAIN} ะธะท Windows hosts...${NC}"
            echo -e "${YELLOW}ะกะตะนัะฐั ะฟะพัะฒะธััั ะพะบะฝะพ UAC - ะฝะฐะถะผะธัะต 'ะะฐ'${NC}"
            echo -e "${YELLOW}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
            sleep 2
            
            # ะััะฐะตะผัั ัะดะฐะปะธัั ัะตัะตะท PowerShell ั ะฟัะฐะฒะฐะผะธ ะฐะดะผะธะฝะธัััะฐัะพัะฐ
            powershell.exe -Command "Start-Process powershell -Verb RunAs -ArgumentList '-NoProfile -Command \"(Get-Content C:\\Windows\\System32\\drivers\\etc\\hosts) -notmatch ''${SELECTED_DOMAIN}'' | Set-Content C:\\Windows\\System32\\drivers\\etc\\hosts\"' -Wait" 2>/dev/null
            if [[ $? -eq 0 ]]; then
                echo -e "${GREEN}โ ะะพะผะตะฝ ${SELECTED_DOMAIN} ัะดะฐะปัะฝ ะธะท Windows hosts${NC}"
            else
                echo -e "${YELLOW}โ ะะต ัะดะฐะปะพัั ัะดะฐะปะธัั ะฐะฒัะพะผะฐัะธัะตัะบะธ${NC}"
                echo -e "${BLUE}ะฃะดะฐะปะธัะต ะฒัััะฝัั ะธะท C:\\Windows\\System32\\drivers\\etc\\hosts ัััะพะบั:${NC}"
                echo -e "   ${GREEN}127.0.0.1 ${SELECTED_DOMAIN}${NC}"
            fi
        else
            echo -e "${GREEN}โ ะะพะผะตะฝ ${SELECTED_DOMAIN} ัะถะต ัะดะฐะปัะฝ ะธะท Windows hosts${NC}"
        fi
    fi
    
    echo ""
    echo -e "${GREEN}โ ะัะพะตะบั '${SELECTED_PROJECT}' ััะฟะตัะฝะพ ัะดะฐะปัะฝ${NC}"
}

# ะะปะฐะฒะฝะพะต ะผะตะฝั
main_menu() {
    while true; do
        print_header
        echo "ะัะฑะตัะธัะต ะดะตะนััะฒะธะต:"
        echo ""
        echo "  1) ะกะพะทะดะฐัั ะฝะพะฒัะน ะฟัะพะตะบั"
        echo "  2) ะกะฟะธัะพะบ ะฟัะพะตะบัะพะฒ"
        echo "  3) ะะฐะฟัััะธัั ะฟัะพะตะบั"
        echo "  4) ะััะฐะฝะพะฒะธัั ะฟัะพะตะบั"
        echo "  5) ะฃะดะฐะปะธัั ะฟัะพะตะบั"
        echo "  6) ะัะบัััั ะฟัะพะตะบั ะฒ VS Code"
        echo "  7) ะัะบัััั ัะฐะนั ะฒ ะฑัะฐัะทะตัะต"
        echo "  0) ะััะพะด"
        echo ""
        read -p "ะะฐั ะฒัะฑะพั: " choice
        echo ""
        
        case $choice in
            1) create_project ;;
            2) list_projects ;;
            3) start_project ;;
            4) stop_project ;;
            5) remove_project ;;
            6) open_in_vscode ;;
            7) open_in_browser ;;
            0) 
                echo -e "${BLUE}๐ ะะพ ัะฒะธะดะฐะฝะธั!${NC}"
                exit 0
                ;;
            *) 
                echo -e "${RED}โ ะะตะฒะตัะฝัะน ะฒัะฑะพั${NC}"
                ;;
        esac
        
        echo ""
        read -p "ะะฐะถะผะธัะต Enter ะดะปั ะฟัะพะดะพะปะถะตะฝะธั..."
        clear
    done
}

# ะกะพะทะดะฐัะผ ะดะธัะตะบัะพัะธั ะดะปั ะฟัะพะตะบัะพะฒ ะตัะปะธ ะฝะต ัััะตััะฒัะตั
mkdir -p "$WWW_PATH"

# ะะฐะฟััะบะฐะตะผ ะณะปะฐะฒะฝะพะต ะผะตะฝั
clear
main_menu
