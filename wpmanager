#!/bin/bash
# ================================
# WordPress Manager —Å Docker
# –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞–º–∏
# ================================

set -e

# –ü–æ–¥–∫–ª—é—á–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [[ -f "$SCRIPT_DIR/dependencies.sh" ]]; then
    source "$SCRIPT_DIR/dependencies.sh"
    check_dependencies
fi

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å–∫—Ä–∏–ø—Ç–∞ –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∏–º–æ—Å—Ç–∏
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–±—Å–æ–ª—é—Ç–Ω—ã–µ –ø—É—Ç–∏ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
WWW_PATH="/home/konst/www"
PROJECTS_FILE="/home/konst/.wp-projects.txt"

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü–∏—è –≤—ã–≤–æ–¥–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞
print_header() {
    echo -e "${BLUE}================================${NC}"
    echo -e "${BLUE}  WordPress Manager${NC}"
    echo -e "${BLUE}================================${NC}"
    echo ""
}

# –§—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ –∏–∑ —Å–ø–∏—Å–∫–∞
select_project() {
    local filter_type="$1"  # all, running, stopped
    local projects=()
    local domains=()
    local ports=()
    local adminer_ports=()
    local paths=()
    
    if [[ ! -f "$PROJECTS_FILE" ]] || [[ ! -s "$PROJECTS_FILE" ]]; then
        echo -e "${YELLOW}‚Ñπ –ù–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤${NC}"
        return 1
    fi
    
    # –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ñ–∏–ª—å—Ç—Ä–∞
    while IFS='|' read -r name domain port adminer_port path; do
        if [[ -d "$path" ]]; then
            local add_project=0
            
            if [[ "$filter_type" == "all" ]]; then
                add_project=1
            elif [[ "$filter_type" == "running" ]]; then
                if docker ps --format '{{.Names}}' | grep -q "^${name}_wp$"; then
                    add_project=1
                fi
            elif [[ "$filter_type" == "stopped" ]]; then
                if docker ps -a --format '{{.Names}}' | grep -q "^${name}_wp$" && ! docker ps --format '{{.Names}}' | grep -q "^${name}_wp$"; then
                    add_project=1
                fi
            fi
            
            if [[ $add_project -eq 1 ]]; then
                projects+=("$name")
                domains+=("$domain")
                ports+=("$port")
                adminer_ports+=("$adminer_port")
                paths+=("$path")
            fi
        fi
    done < "$PROJECTS_FILE"
    
    if [[ ${#projects[@]} -eq 0 ]]; then
        if [[ "$filter_type" == "running" ]]; then
            echo -e "${YELLOW}‚Ñπ –ù–µ—Ç –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤${NC}"
        elif [[ "$filter_type" == "stopped" ]]; then
            echo -e "${YELLOW}‚Ñπ –ù–µ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤${NC}"
        else
            echo -e "${YELLOW}‚Ñπ –ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤${NC}"
        fi
        return 1
    fi
    
    echo -e "${BLUE}–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç:${NC}"
    echo ""
    
    local i=1
    for name in "${projects[@]}"; do
        local idx=$((i-1))
        echo -e "  ${GREEN}${i})${NC} ${name} (${domains[$idx]})"
        ((i++))
    done
    echo ""
    echo -e "  ${YELLOW}0)${NC} –û—Ç–º–µ–Ω–∞"
    echo ""
    
    read -p "–í–∞—à –≤—ã–±–æ—Ä: " choice
    
    if [[ "$choice" == "0" ]]; then
        echo -e "${YELLOW}‚Ñπ –û—Ç–º–µ–Ω–µ–Ω–æ${NC}"
        return 1
    fi
    
    if [[ "$choice" =~ ^[0-9]+$ ]] && [[ $choice -ge 1 ]] && [[ $choice -le ${#projects[@]} ]]; then
        local idx=$((choice-1))
        SELECTED_PROJECT="${projects[$idx]}"
        SELECTED_DOMAIN="${domains[$idx]}"
        SELECTED_PORT="${ports[$idx]}"
        SELECTED_ADMINER_PORT="${adminer_ports[$idx]}"
        SELECTED_PATH="${paths[$idx]}"
        return 0
    else
        echo -e "${RED}‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä${NC}"
        return 1
    fi
}

# –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –ø–æ—Ä—Ç–∞
get_free_port() {
    local port=80
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ä—Ç—ã –Ω–∞—á–∏–Ω–∞—è —Å 80
    while true; do
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ Docker - –Ω–µ –∑–∞–Ω—è—Ç –ª–∏ –ø–æ—Ä—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º
        if docker ps --format '{{.Ports}}' | grep -q "0.0.0.0:${port}->"; then
            ((port++))
            continue
        fi
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ netstat - –Ω–µ –∑–∞–Ω—è—Ç –ª–∏ –ø–æ—Ä—Ç —Å–∏—Å—Ç–µ–º–æ–π
        if netstat -tuln 2>/dev/null | grep -q ":${port} "; then
            ((port++))
            continue
        fi
        
        # –ü–æ—Ä—Ç —Å–≤–æ–±–æ–¥–µ–Ω
        echo "$port"
        return
    done
}

# –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
create_project() {
    echo -e "${GREEN}‚ñ∂ –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ WordPress –ø—Ä–æ–µ–∫—Ç–∞${NC}"
    echo ""
    
    read -p "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–º—ã/–ø—Ä–æ–µ–∫—Ç–∞ (–ø—Ä–∏–º–µ—Ä: my-site): " THEME_NAME
    if [[ -z "$THEME_NAME" ]]; then
        echo -e "${RED}‚ùå –ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º${NC}"
        return 1
    fi
    
    # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –≤–≤–æ–¥ –∏–º–µ–Ω–∏ —Ç–µ–º—ã:
    # - —É–¥–∞–ª—è–µ–º/–∑–∞–º–µ—â–∞–µ–º –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ/–Ω–µ–≤–∏–¥–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã
    # - –æ–±—Ä–µ–∑–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –ø–æ –∫—Ä–∞—è–º
    # - –∑–∞–º–µ–Ω—è–µ–º –ª—é–±—ã–µ –ø—Ä–æ–±–µ–ª—å–Ω—ã–µ –≥—Ä—É–ø–ø—ã –Ω–∞ –¥–µ—Ñ–∏—Å
    # - –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –¥–µ—Ñ–∏—Å –∏ –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ
    # - –ø—Ä–∏–≤–æ–¥–∏–º –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
    # - —Å—Ö–ª–æ–ø—ã–≤–∞–µ–º –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –¥–µ—Ñ–∏—Å—ã/–ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏—è –∏ —É–±–∏—Ä–∞–µ–º –∫—Ä–∞–µ–≤—ã–µ
    THEME_NAME=$(echo "$THEME_NAME" | { iconv -f UTF-8 -t UTF-8 -c 2>/dev/null || cat; } )
    THEME_NAME=$(echo "$THEME_NAME" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
    THEME_NAME=$(echo "$THEME_NAME" | sed 's/[[:space:]]\+/-/g')
    THEME_NAME=$(echo "$THEME_NAME" | sed 's/[^a-zA-Z0-9_-]//g' | tr '[:upper:]' '[:lower:]')
    THEME_NAME=$(echo "$THEME_NAME" | sed 's/[-_]\+/-/g' | sed 's/^-//' | sed 's/-$//')
    # –ï—Å–ª–∏ –Ω–∞—á–∞–ª–æ –∏–º–µ–Ω–∏ —Ü–∏—Ñ—Ä–∞ ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å
    if [[ $THEME_NAME =~ ^[0-9] ]]; then
        THEME_NAME="t_${THEME_NAME}"
    fi
    
    if [[ -z "$THEME_NAME" ]]; then
        echo -e "${RED}‚ùå –ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –¥–µ—Ñ–∏—Å –∏–ª–∏ –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ${NC}"
        return 1
    fi
    
    echo -e "${BLUE}‚Ñπ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞–∑–≤–∞–Ω–∏–µ: ${THEME_NAME}${NC}"
    
    read -p "–í–≤–µ–¥–∏—Ç–µ –¥–æ–º–µ–Ω (–ø—Ä–∏–º–µ—Ä: my-site.local): " DOMAIN
    if [[ -z "$DOMAIN" ]]; then
        DOMAIN="${THEME_NAME}.local"
        echo -e "${YELLOW}‚Ñπ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–æ–º–µ–Ω: ${DOMAIN}${NC}"
    fi
    
    WP_PATH="${WWW_PATH}/${THEME_NAME}"
    
    if [[ -d "$WP_PATH" ]]; then
        echo -e "${RED}‚ùå –ü—Ä–æ–µ–∫—Ç '${THEME_NAME}' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ ${WP_PATH}${NC}"
        return 1
    fi
    
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∑–∞–ø—É—â–µ–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã
    echo ""
    echo -e "${YELLOW}üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –≤—Å–µ –∑–∞–ø—É—â–µ–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã...${NC}"
    
    if [[ -f "$PROJECTS_FILE" ]]; then
        while IFS='|' read -r name domain port path; do
            if [[ -d "$path" ]] && docker ps --format '{{.Names}}' | grep -q "^${name}_wp$"; then
                echo -e "   –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é ${name}..."
                cd "$path" && docker compose stop 2>/dev/null
            fi
        done < "$PROJECTS_FILE"
    fi
    
    echo ""
    echo -e "${BLUE}üì¶ –°–æ–∑–¥–∞—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞...${NC}"
    mkdir -p "$WP_PATH/wp-content/themes"
    mkdir -p "$WP_PATH/wp-content/plugins"
    mkdir -p "$WP_PATH/wp-content/uploads"
    
    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ –ø–∞—Ä–æ–ª—è
    DB_PASS=$(openssl rand -base64 16 | tr -d "=+/" | cut -c1-16)
    SAFE_DB_NAME=$(echo "$THEME_NAME" | tr '-' '_' | tr '[:upper:]' '[:lower:]')
    DB_NAME="wp_${SAFE_DB_NAME}"
    DB_USER="${SAFE_DB_NAME}_user"
    
    # –ü–æ–ª—É—á–∞–µ–º —Å–≤–æ–±–æ–¥–Ω—ã–π –ø–æ—Ä—Ç
    PORT=$(get_free_port)
    ADMINER_PORT=$(get_free_port)
    
    echo -e "${BLUE}üê≥ –°–æ–∑–¥–∞—é docker-compose.yml...${NC}"
    
    # –°–æ–∑–¥–∞–Ω–∏–µ docker-compose.yml
    cat > "$WP_PATH/docker-compose.yml" <<'YAML'

services:
  db:
    image: mysql:8.0
    container_name: PROJECTNAME_db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: DBPASS
      MYSQL_DATABASE: DBNAME
      MYSQL_USER: DBUSER
      MYSQL_PASSWORD: DBPASS
    volumes:
      - db_data:/var/lib/mysql
    networks:
      - wp_network

  wordpress:
    image: wordpress:php8.4-apache
    container_name: PROJECTNAME_wp
    restart: unless-stopped
    depends_on:
      - db
    ports:
      - "PORTNUM:80"
    environment:
      WORDPRESS_DB_HOST: db:3306
      WORDPRESS_DB_USER: DBUSER
      WORDPRESS_DB_PASSWORD: DBPASS
      WORDPRESS_DB_NAME: DBNAME
      WORDPRESS_TABLE_PREFIX: wp_
      WORDPRESS_DEBUG: 1
    volumes:
      - ./wp-content:/var/www/html/wp-content
    networks:
      - wp_network

  adminer:
    image: phpmyadmin/phpmyadmin
    restart: unless-stopped
    depends_on:
      - db
    ports:
      - "ADMINERPORT:80"
    environment:
      PMA_HOST: PROJECTNAME_db
      PMA_PORT: 3306
      PMA_USER: DBUSER
      PMA_PASSWORD: DBPASS
      PMA_DB: DBNAME
    networks:
      - wp_network

volumes:
  db_data:

networks:
  wp_network:
    driver: bridge
YAML

    sed -i "s/PROJECTNAME/${THEME_NAME}/g" "$WP_PATH/docker-compose.yml"
    sed -i "s/DBPASS/${DB_PASS}/g" "$WP_PATH/docker-compose.yml"
    sed -i "s/DBNAME/${DB_NAME}/g" "$WP_PATH/docker-compose.yml"
    sed -i "s/DBUSER/${DB_USER}/g" "$WP_PATH/docker-compose.yml"
    sed -i "s/PORTNUM/${PORT}/g" "$WP_PATH/docker-compose.yml"
    sed -i "s/ADMINERPORT/${ADMINER_PORT}/g" "$WP_PATH/docker-compose.yml"
    sed -i "s/PMA_USER: DBUSER/PMA_USER: ${DB_USER}/g" "$WP_PATH/docker-compose.yml"
    sed -i "s/PMA_PASSWORD: DBPASS/PMA_PASSWORD: ${DB_PASS}/g" "$WP_PATH/docker-compose.yml"
    sed -i "s/PMA_DB: DBNAME/PMA_DB: ${DB_NAME}/g" "$WP_PATH/docker-compose.yml"

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–µ–∫—Ç–µ
    cat > "$WP_PATH/.project-info" <<INFO
PROJECT_NAME=${THEME_NAME}
DOMAIN=${DOMAIN}
PORT=${PORT}
ADMINER_PORT=${ADMINER_PORT}
DB_NAME=${DB_NAME}
DB_USER=${DB_USER}
DB_PASS=${DB_PASS}
CREATED=$(date '+%Y-%m-%d %H:%M:%S')
INFO

    # –°–∫–∞—á–∏–≤–∞–µ–º WordPress
    echo -e "${BLUE}üì• –°–∫–∞—á–∏–≤–∞—é WordPress...${NC}"
    wget -q https://wordpress.org/latest.tar.gz -O /tmp/wp.tar.gz
    if [[ $? -ne 0 ]]; then
        echo -e "${RED}‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å WordPress${NC}"
        return 1
    fi
    
    # –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º WordPress
    echo -e "${BLUE}üì¶ –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞—é WordPress...${NC}"
    tar -xzf /tmp/wp.tar.gz -C "$WP_PATH" --strip-components=1
    if [[ $? -ne 0 ]]; then
        echo -e "${RED}‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞–∫–æ–≤–∞—Ç—å WordPress${NC}"
        return 1
    fi
    
    # –£–¥–∞–ª—è–µ–º wp-content –∏–∑ —Ä–∞—Å–ø–∞–∫–æ–≤–∞–Ω–Ω–æ–≥–æ, —á—Ç–æ–±—ã –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–ª—Å—è –ª–æ–∫–∞–ª—å–Ω—ã–π
    rm -rf "$WP_PATH/wp-content"

    # –°–æ–∑–¥–∞—ë–º –±–∞–∑–æ–≤—É—é —Ç–µ–º—É —á–µ—Ä–µ–∑ –≤–Ω–µ—à–Ω–∏–π —à–∞–±–ª–æ–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç (–∏—â–µ–º –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö)
    THEME_DIR="$WP_PATH/wp-content/themes/$THEME_NAME"
    # –ò—â–µ–º —à–∞–±–ª–æ–Ω —Å–Ω–∞—á–∞–ª–∞ –≤ /usr/local/bin, –∑–∞—Ç–µ–º —Ä—è–¥–æ–º —Å–æ —Å–∫—Ä–∏–ø—Ç–æ–º, –∏–Ω–∞—á–µ —Å–æ–∑–¥–∞—ë–º –ø—É—Å—Ç—É—é –ø–∞–ø–∫—É
    if [[ -f "/usr/local/bin/theme-template.sh" ]]; then
        # –ø–æ–¥–∫–ª—é—á–∞–µ–º –∏ –≤—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ–º—ã
        source /usr/local/bin/theme-template.sh
        create_theme_files "$THEME_DIR" "$THEME_NAME" "$WP_PATH" || true
    elif [[ -f "$SCRIPT_DIR/theme-template.sh" ]]; then
        # –ª–æ–∫–∞–ª—å–Ω–∞—è –∫–æ–ø–∏—è —Ä—è–¥–æ–º —Å–æ —Å–∫—Ä–∏–ø—Ç–æ–º (—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π)
        source "$SCRIPT_DIR/theme-template.sh"
        create_theme_files "$THEME_DIR" "$THEME_NAME" "$WP_PATH" || true
    else
        # fallback ‚Äî –ø—Ä–æ—Å—Ç–æ —Å–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Ç–µ–º—ã
        mkdir -p "$THEME_DIR"
    fi

    # –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–µ–∫—Ç–æ–≤ (—Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π UTF-8)
    printf "%s|%s|%s|%s|%s\n" "${THEME_NAME}" "${DOMAIN}" "${PORT}" "${ADMINER_PORT}" "${WP_PATH}" >> "$PROJECTS_FILE"
    
    echo -e "${BLUE}üöÄ –ó–∞–ø—É—Å–∫–∞—é Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã...${NC}"
    
    # –ó–∞–ø—É—Å–∫ docker-compose
    cd "$WP_PATH"
    if command -v docker >/dev/null && docker compose version >/dev/null 2>&1; then
        docker compose up -d
    elif command -v docker-compose >/dev/null; then
        docker-compose up -d
    else
        echo -e "${RED}‚ùå Docker compose –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Docker Desktop.${NC}"
        return 1
    fi
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    echo -e "${BLUE}üîß –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –ø—Ä–∞–≤–∞ –Ω–∞ —Ñ–∞–π–ª—ã...${NC}"
    sudo chown -R "$USER:$USER" "$WP_PATH"
    chmod -R 755 "$WP_PATH"
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–æ–º–µ–Ω–∞ –≤ /etc/hosts (WSL)
    echo -e "${BLUE}üîß –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—é –ª–æ–∫–∞–ª—å–Ω—ã–π –¥–æ–º–µ–Ω...${NC}"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∑–∞–ø–∏—Å—å –≤ hosts
    if ! grep -q "127.0.0.1.*${DOMAIN}" /etc/hosts 2>/dev/null; then
        echo "127.0.0.1 ${DOMAIN}" | sudo tee -a /etc/hosts >/dev/null
        echo -e "${GREEN}‚úÖ –î–æ–º–µ–Ω ${DOMAIN} –¥–æ–±–∞–≤–ª–µ–Ω –≤ /etc/hosts (WSL)${NC}"
    else
        echo -e "${YELLOW}‚Ñπ –î–æ–º–µ–Ω ${DOMAIN} —É–∂–µ –µ—Å—Ç—å –≤ /etc/hosts (WSL)${NC}"
    fi
    
    # –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–º–µ–Ω –≤ Windows hosts —Ñ–∞–π–ª –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    WIN_HOSTS="/mnt/c/Windows/System32/drivers/etc/hosts"
    
    if [[ -f "$WIN_HOSTS" ]]; then
        if ! grep -q "127.0.0.1.*${DOMAIN}" "$WIN_HOSTS" 2>/dev/null; then
            echo ""
            echo -e "${YELLOW}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
            echo -e "${BLUE}üîß –î–æ–±–∞–≤–ª—è—é –¥–æ–º–µ–Ω ${DOMAIN} –≤ Windows hosts...${NC}"
            echo -e "${YELLOW}–°–µ–π—á–∞—Å –ø–æ—è–≤–∏—Ç—Å—è –æ–∫–Ω–æ UAC - –Ω–∞–∂–º–∏—Ç–µ '–î–∞'${NC}"
            echo -e "${YELLOW}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
            sleep 2
            
            # –ü—ã—Ç–∞–µ–º—Å—è –¥–æ–±–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ PowerShell —Å –ø—Ä–∞–≤–∞–º–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
            if powershell.exe -Command "Start-Process powershell -Verb RunAs -ArgumentList '-NoProfile -Command \"Add-Content C:\\Windows\\System32\\drivers\\etc\\hosts ''127.0.0.1 ${DOMAIN}''\"' -Wait" 2>/dev/null; then
                echo -e "${GREEN}‚úÖ –î–æ–º–µ–Ω ${DOMAIN} –¥–æ–±–∞–≤–ª–µ–Ω –≤ Windows hosts${NC}"
            else
                echo -e "${YELLOW}‚ö† –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏${NC}"
                echo -e "${BLUE}–í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤—Ä—É—á–Ω—É—é –≤ PowerShell –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:${NC}"
                echo -e "   ${GREEN}Add-Content C:\\Windows\\System32\\drivers\\etc\\hosts '127.0.0.1 ${DOMAIN}'${NC}"
            fi
        else
            echo -e "${GREEN}‚úÖ –î–æ–º–µ–Ω ${DOMAIN} —É–∂–µ –µ—Å—Ç—å –≤ Windows hosts${NC}"
        fi
    fi
    
    echo ""
    echo -e "${GREEN}‚úÖ –ü—Ä–æ–µ–∫—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!${NC}"
    echo ""
    echo -e "${YELLOW}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo -e "${GREEN}üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ:${NC}"
    echo -e "${YELLOW}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo -e "  –ü—Ä–æ–µ–∫—Ç:     ${THEME_NAME}"
    echo -e "  –î–æ–º–µ–Ω:      ${DOMAIN}"
    echo -e "  –ü—É—Ç—å:       ${WP_PATH}"
    echo -e ""
    echo -e "${GREEN}üåç –î–æ—Å—Ç—É–ø –∫ —Å–∞–π—Ç—É:${NC}"
    if [[ "$PORT" == "80" ]]; then
        echo -e "  –ü–æ –¥–æ–º–µ–Ω—É:     ${GREEN}http://${DOMAIN}${NC}"
        echo -e "  –ü–æ IP:         http://localhost"
    else
        echo -e "  –ü–æ –¥–æ–º–µ–Ω—É:     ${GREEN}http://${DOMAIN}:${PORT}${NC}"
        echo -e "  –ü–æ IP:         http://localhost:${PORT}"
    fi
    echo -e ""
    echo -e "${GREEN}üîê –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:${NC}"
    echo -e "  –ë–î:         ${DB_NAME}"
    echo -e "  –Æ–∑–µ—Ä:       ${DB_USER}"
    echo -e "  –ü–∞—Ä–æ–ª—å:     ${DB_PASS}"
    echo -e ""
    if [[ "$PORT" == "80" ]]; then
        echo -e "${BLUE}üí° –û—Ç–∫—Ä–æ–π—Ç–µ ${GREEN}http://${DOMAIN}${BLUE} –≤ –±—Ä–∞—É–∑–µ—Ä–µ Windows${NC}"
    else
        echo -e "${BLUE}üí° –û—Ç–∫—Ä–æ–π—Ç–µ ${GREEN}http://${DOMAIN}:${PORT}${BLUE} –≤ –±—Ä–∞—É–∑–µ—Ä–µ Windows${NC}"
    fi
    echo -e "${BLUE}   –∏ –ø—Ä–æ–π–¥–∏—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∫—É WordPress${NC}"
    echo -e "${YELLOW}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo ""
}

# –§—É–Ω–∫—Ü–∏—è —Å–ø–∏—Å–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤
list_projects() {
    echo -e "${GREEN}‚ñ∂ –°–ø–∏—Å–æ–∫ –ø—Ä–æ–µ–∫—Ç–æ–≤${NC}"
    echo ""
    
    if [[ ! -f "$PROJECTS_FILE" ]] || [[ ! -s "$PROJECTS_FILE" ]]; then
        echo -e "${YELLOW}‚Ñπ –ù–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤${NC}"
        return
    fi
    
    printf "%-20s %-25s %-10s %-12s %s\n" "–ü–†–û–ï–ö–¢" "–î–û–ú–ï–ù" "–ü–û–†–¢" "ADMINER" "–°–¢–ê–¢–£–°"
    echo -e "${YELLOW}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    
    while IFS='|' read -r name domain port adminer_port path; do
        if [[ -d "$path" ]]; then
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            if docker ps --format '{{.Names}}' | grep -q "^${name}_wp$"; then
                status="${GREEN}‚óè${NC} Running"
            elif docker ps -a --format '{{.Names}}' | grep -q "^${name}_wp$"; then
                status="${YELLOW}‚óè${NC} Stopped"
            else
                status="${RED}‚óè${NC} Not found"
            fi
            printf "%-20s %-25s %-10s %-12s %b\n" "$name" "$domain" "$port" "$adminer_port" "$status"
        fi
    done < "$PROJECTS_FILE"
    
    echo -e "${YELLOW}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo ""
}

# –§—É–Ω–∫—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞
stop_project() {
    echo -e "${YELLOW}‚ñ∂ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞${NC}"
    echo ""
    
    if ! select_project "running"; then
        return
    fi
    
    cd "$SELECTED_PATH"
    
    if command -v docker >/dev/null && docker compose version >/dev/null 2>&1; then
        docker compose stop
    elif command -v docker-compose >/dev/null; then
        docker-compose stop
    fi
    
    echo ""
    echo -e "${GREEN}‚úÖ –ü—Ä–æ–µ–∫—Ç '${SELECTED_PROJECT}' –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω${NC}"
}

# –§—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
start_project() {
    echo -e "${GREEN}‚ñ∂ –ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞${NC}"
    echo ""
    
    if ! select_project "stopped"; then
        return
    fi
    
    cd "$SELECTED_PATH"
    
    if command -v docker >/dev/null && docker compose version >/dev/null 2>&1; then
        docker compose start
    elif command -v docker-compose >/dev/null; then
        docker-compose start
    fi
    
    echo ""
    echo -e "${GREEN}‚úÖ –ü—Ä–æ–µ–∫—Ç '${SELECTED_PROJECT}' –∑–∞–ø—É—â–µ–Ω${NC}"
    if [[ "$SELECTED_PORT" == "80" ]]; then
        echo -e "${BLUE}üåç –î–æ—Å—Ç—É–ø: http://${SELECTED_DOMAIN}${NC}"
    else
        echo -e "${BLUE}üåç –î–æ—Å—Ç—É–ø: http://${SELECTED_DOMAIN}:${SELECTED_PORT}${NC}"
    fi
}

# –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
open_in_browser() {
    echo -e "${BLUE}‚ñ∂ –û—Ç–∫—Ä—ã—Ç—å —Å–∞–π—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ${NC}"
    echo ""
    
    if ! select_project "all"; then
        return
    fi
    
    echo ""
    echo -e "${BLUE}üåç –û—Ç–∫—Ä—ã–≤–∞—é —Å–∞–π—Ç: http://localhost:${SELECTED_PORT}${NC}"
    
    # –û—Ç–∫—Ä—ã–≤–∞–µ–º –≤ –±—Ä–∞—É–∑–µ—Ä–µ
    if command -v xdg-open >/dev/null 2>&1; then
        xdg-open "http://localhost:${SELECTED_PORT}" >/dev/null 2>&1 &
        echo -e "${GREEN}‚úÖ –ë—Ä–∞—É–∑–µ—Ä –∑–∞–ø—É—â–µ–Ω${NC}"
    elif command -v powershell.exe >/dev/null 2>&1 || [[ -x "/mnt/c/Windows/System32/WindowsPowerShell/v1.0/powershell.exe" ]]; then
        local ps_cmd="powershell.exe"
        if ! command -v powershell.exe >/dev/null 2>&1; then
            ps_cmd="/mnt/c/Windows/System32/WindowsPowerShell/v1.0/powershell.exe"
        fi
        "$ps_cmd" -Command "Start-Process 'http://localhost:${SELECTED_PORT}'" 2>/dev/null &
        echo -e "${GREEN}‚úÖ –ë—Ä–∞—É–∑–µ—Ä –∑–∞–ø—É—â–µ–Ω${NC}"
    else
        echo -e "${YELLOW}‚ö† –û—Ç–∫—Ä–æ–π—Ç–µ –≤—Ä—É—á–Ω—É—é: http://localhost:${SELECTED_PORT}${NC}"
    fi
}

# –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –≤ VS Code
open_in_vscode() {
    echo -e "${BLUE}‚ñ∂ –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ–µ–∫—Ç –≤ VS Code${NC}"
    echo ""
    
    if ! select_project "all"; then
        return
    fi
    
    echo ""
    echo -e "${BLUE}–í—ã–±–µ—Ä–∏—Ç–µ, —á—Ç–æ –æ—Ç–∫—Ä—ã—Ç—å:${NC}"
    echo ""
    echo "  1) –í–µ—Å—å —Å–∞–π—Ç (–≤—Å–µ –∏—Å—Ö–æ–¥–Ω–∏–∫–∏ WordPress)"
    echo "  2) –¢–æ–ª—å–∫–æ wp-content (—Ç–µ–º—ã, –ø–ª–∞–≥–∏–Ω—ã, –∑–∞–≥—Ä—É–∑–∫–∏)"
    echo "  3) –¢–æ–ª—å–∫–æ —Ç–µ–º–∞ –ø—Ä–æ–µ–∫—Ç–∞"
    echo ""
    read -p "–í–∞—à –≤—ã–±–æ—Ä (1, 2 –∏–ª–∏ 3): " open_choice
    
    case $open_choice in
        1) open_path="$SELECTED_PATH" ;;
        2) 
            open_path="$SELECTED_PATH/wp-content"
            [[ ! -d "$open_path" ]] && { echo -e "${YELLOW}‚ö† wp-content –Ω–µ –Ω–∞–π–¥–µ–Ω, –æ—Ç–∫—Ä—ã–≤–∞—é –≤–µ—Å—å —Å–∞–π—Ç${NC}"; open_path="$SELECTED_PATH"; }
            ;;
        3)
            open_path="$SELECTED_PATH/wp-content/themes/$SELECTED_PROJECT"
            [[ ! -d "$open_path" ]] && { echo -e "${YELLOW}‚ö† –¢–µ–º–∞ '$SELECTED_PROJECT' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –æ—Ç–∫—Ä—ã–≤–∞—é wp-content${NC}"; open_path="$SELECTED_PATH/wp-content"; }
            ;;
        *) open_path="$SELECTED_PATH"; echo -e "${YELLOW}‚Ñπ –í—ã–±—Ä–∞–Ω –≤–µ—Å—å —Å–∞–π—Ç${NC}" ;;
    esac
    
    echo ""
    echo -e "${BLUE}üöÄ –û—Ç–∫—Ä—ã–≤–∞—é ${open_path} –≤ VS Code...${NC}"
    
    # –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ WSL code
    if command -v code >/dev/null 2>&1; then
        cd "$open_path" && code . >/dev/null 2>&1
        [[ $? -eq 0 ]] && { echo -e "${GREEN}‚úÖ VS Code –∑–∞–ø—É—â–µ–Ω${NC}"; echo -e "${BLUE}   –ü–∞–ø–∫–∞: ${open_path}${NC}"; return; }
    fi
    
    # –û—Ç–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ PowerShell –≤ Windows
    local wsl_distro=$(lsb_release -si 2>/dev/null || echo "Ubuntu")
    local win_path=$(wslpath -w "$open_path" 2>/dev/null || echo "\\\\wsl\$\\${wsl_distro}${open_path}")
    
    local ps_cmd="powershell.exe"
    [[ ! $(command -v powershell.exe) ]] && ps_cmd="/mnt/c/Windows/System32/WindowsPowerShell/v1.0/powershell.exe"
    
    if [[ -x "$ps_cmd" ]]; then
        "$ps_cmd" -Command "code '${win_path}'" >/dev/null 2>&1
        if [[ $? -eq 0 ]]; then
            echo -e "${GREEN}‚úÖ VS Code –∑–∞–ø—É—â–µ–Ω${NC}"
            echo -e "${BLUE}   –ü–∞–ø–∫–∞: ${win_path}${NC}"
        else
            echo -e "${RED}‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å VS Code —á–µ—Ä–µ–∑ PowerShell${NC}"
            echo -e "${YELLOW}–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–∫—Ä—ã—Ç—å –≤—Ä—É—á–Ω—É—é: ${win_path}${NC}"
        fi
    else
        echo -e "${RED}‚ùå PowerShell –Ω–µ –Ω–∞–π–¥–µ–Ω${NC}"
        echo -e "${YELLOW}–û—Ç–∫—Ä–æ–π—Ç–µ –≤—Ä—É—á–Ω—É—é: ${win_path}${NC}"
    fi
}


# –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞
open_project_db() {
    echo -e "${BLUE}‚ñ∂ –û—Ç–∫—Ä—ã—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞${NC}"
    echo ""
    
    if ! select_project "all"; then
        return
    fi
    
    echo ""
    echo -e "${BLUE}–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –¥–æ—Å—Ç—É–ø–∞:${NC}"
    echo ""
    echo "  1) –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ MySQL –∫–ª–∏–µ–Ω—Ç (–∫–æ–Ω—Å–æ–ª—å)"
    echo "  2) –û—Ç–∫—Ä—ã—Ç—å phpMyAdmin –≤ –±—Ä–∞—É–∑–µ—Ä–µ"
    echo ""
    read -p "–í–∞—à –≤—ã–±–æ—Ä (1 –∏–ª–∏ 2): " db_choice
    
    case $db_choice in
        1)
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω –ª–∏ –ø—Ä–æ–µ–∫—Ç
            if ! docker ps --format '{{.Names}}' | grep -q "^${SELECTED_PROJECT}_wp$"; then
                echo -e "${YELLOW}‚ö† –ü—Ä–æ–µ–∫—Ç '${SELECTED_PROJECT}' –Ω–µ –∑–∞–ø—É—â–µ–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –µ–≥–æ —Å–Ω–∞—á–∞–ª–∞.${NC}"
                return
            fi
            open_db_for_project "$SELECTED_PROJECT" "$SELECTED_PATH"
            ;;
        *)
            # –ß–∏—Ç–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ë–î –∏–∑ .project-info
            PROJECT_INFO_FILE="$SELECTED_PATH/.project-info"
            if [[ -f "$PROJECT_INFO_FILE" ]]; then
                DB_NAME=$(grep "^DB_NAME=" "$PROJECT_INFO_FILE" | cut -d'=' -f2)
                DB_USER=$(grep "^DB_USER=" "$PROJECT_INFO_FILE" | cut -d'=' -f2)
                DB_PASS=$(grep "^DB_PASS=" "$PROJECT_INFO_FILE" | cut -d'=' -f2)
                
                if [[ -n "$DB_NAME" && -n "$DB_USER" ]]; then
                    echo -e "${BLUE}üåç –û—Ç–∫—Ä—ã–≤–∞—é phpMyAdmin: http://localhost:${SELECTED_ADMINER_PORT}${NC}"
                    echo -e "${YELLOW}–í –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ –≤—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä 'db', –≤–≤–µ–¥–∏—Ç–µ:${NC}"
                    echo -e "${YELLOW}–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${DB_USER}${NC}"
                    echo -e "${YELLOW}–ü–∞—Ä–æ–ª—å: ${DB_PASS}${NC}"
                    echo -e "${YELLOW}–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: ${DB_NAME}${NC}"
                    echo ""
                    
                    # –û—Ç–∫—Ä—ã–≤–∞–µ–º –≤ –±—Ä–∞—É–∑–µ—Ä–µ
                    if command -v xdg-open >/dev/null 2>&1; then
                        xdg-open "http://localhost:${SELECTED_ADMINER_PORT}" >/dev/null 2>&1 &
                        echo -e "${GREEN}‚úÖ –ë—Ä–∞—É–∑–µ—Ä –∑–∞–ø—É—â–µ–Ω${NC}"
                    elif command -v powershell.exe >/dev/null 2>&1 || [[ -x "/mnt/c/Windows/System32/WindowsPowerShell/v1.0/powershell.exe" ]]; then
                        local ps_cmd="powershell.exe"
                        if ! command -v powershell.exe >/dev/null 2>&1; then
                            ps_cmd="/mnt/c/Windows/System32/WindowsPowerShell/v1.0/powershell.exe"
                        fi
                        "$ps_cmd" -Command "Start-Process 'http://localhost:${SELECTED_ADMINER_PORT}'" 2>/dev/null &
                        echo -e "${GREEN}‚úÖ –ë—Ä–∞—É–∑–µ—Ä –∑–∞–ø—É—â–µ–Ω${NC}"
                    else
                        echo -e "${YELLOW}‚ö† –û—Ç–∫—Ä–æ–π—Ç–µ –≤—Ä—É—á–Ω—É—é: http://localhost:${SELECTED_ADMINER_PORT}${NC}"
                        echo -e "${YELLOW}–ü–∞—Ä–æ–ª—å: ${DB_PASS}${NC}"
                    fi
                else
                    echo -e "${RED}‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö${NC}"
                    echo -e "${BLUE}üåç –û—Ç–∫—Ä—ã–≤–∞—é phpMyAdmin: http://localhost:${SELECTED_ADMINER_PORT}${NC}"
                    # –û—Ç–∫—Ä—ã–≤–∞–µ–º –≤ –±—Ä–∞—É–∑–µ—Ä–µ
                    if command -v xdg-open >/dev/null 2>&1; then
                        xdg-open "http://localhost:${SELECTED_ADMINER_PORT}" >/dev/null 2>&1 &
                        echo -e "${GREEN}‚úÖ –ë—Ä–∞—É–∑–µ—Ä –∑–∞–ø—É—â–µ–Ω${NC}"
                    elif command -v powershell.exe >/dev/null 2>&1 || [[ -x "/mnt/c/Windows/System32/WindowsPowerShell/v1.0/powershell.exe" ]]; then
                        local ps_cmd="powershell.exe"
                        if ! command -v powershell.exe >/dev/null 2>&1; then
                            ps_cmd="/mnt/c/Windows/System32/WindowsPowerShell/v1.0/powershell.exe"
                        fi
                        "$ps_cmd" -Command "Start-Process 'http://localhost:${SELECTED_ADMINER_PORT}'" 2>/dev/null &
                        echo -e "${GREEN}‚úÖ –ë—Ä–∞—É–∑–µ—Ä –∑–∞–ø—É—â–µ–Ω${NC}"
                    else
                        echo -e "${YELLOW}‚ö† –û—Ç–∫—Ä–æ–π—Ç–µ –≤—Ä—É—á–Ω—É—é: http://localhost:${SELECTED_ADMINER_PORT}${NC}"
                    fi
                fi
            else
                echo -e "${RED}‚ùå –§–∞–π–ª —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø—Ä–æ–µ–∫—Ç–µ –Ω–µ –Ω–∞–π–¥–µ–Ω${NC}"
                echo -e "${BLUE}üåç –û—Ç–∫—Ä—ã–≤–∞—é phpMyAdmin: http://localhost:${SELECTED_ADMINER_PORT}${NC}"
                # –û—Ç–∫—Ä—ã–≤–∞–µ–º –≤ –±—Ä–∞—É–∑–µ—Ä–µ
                if command -v xdg-open >/dev/null 2>&1; then
                    xdg-open "http://localhost:${SELECTED_ADMINER_PORT}" >/dev/null 2>&1 &
                    echo -e "${GREEN}‚úÖ –ë—Ä–∞—É–∑–µ—Ä –∑–∞–ø—É—â–µ–Ω${NC}"
                elif command -v powershell.exe >/dev/null 2>&1; then
                    powershell.exe -Command "Start-Process 'http://localhost:${SELECTED_ADMINER_PORT}'" 2>/dev/null &
                    echo -e "${GREEN}‚úÖ –ë—Ä–∞—É–∑–µ—Ä –∑–∞–ø—É—â–µ–Ω${NC}"
                else
                    echo -e "${YELLOW}‚ö† –û—Ç–∫—Ä–æ–π—Ç–µ –≤—Ä—É—á–Ω—É—é: http://localhost:${SELECTED_ADMINER_PORT}${NC}"
                fi
            fi
            ;;
    esac
}

# –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞
remove_project() {
    echo -e "${RED}‚ñ∂ –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞${NC}"
    echo ""
    
    if ! select_project "all"; then
        return
    fi
    
    echo ""
    echo -e "${YELLOW}‚ö† –í–Ω–∏–º–∞–Ω–∏–µ! –≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ —Ñ–∞–π–ª—ã –∏ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞ '${SELECTED_PROJECT}'.${NC}"
    read -p "–í—ã —É–≤–µ—Ä–µ–Ω—ã? –í–≤–µ–¥–∏—Ç–µ 'yes' –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è: " CONFIRM
    
    if [[ "$CONFIRM" != "yes" ]]; then
        echo -e "${BLUE}‚Ñπ –û—Ç–º–µ–Ω–µ–Ω–æ${NC}"
        return 0
    fi
    
    echo ""
    echo -e "${BLUE}üóë –£–¥–∞–ª—è—é –ø—Ä–æ–µ–∫—Ç...${NC}"
    
    cd "$SELECTED_PATH"
    
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
    if command -v docker >/dev/null && docker compose version >/dev/null 2>&1; then
        docker compose down -v 2>/dev/null || true
    elif command -v docker-compose >/dev/null; then
        docker-compose down -v 2>/dev/null || true
    fi
    
    # –£–¥–∞–ª—è–µ–º –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞ (—Å sudo, —Ç.–∫. Docker —Å–æ–∑–¥–∞—ë—Ç —Ñ–∞–π–ª—ã –æ—Ç root)
    cd "$HOME"
    sudo rm -rf "$SELECTED_PATH"
    
    # –£–¥–∞–ª—è–µ–º –∏–∑ —Å–ø–∏—Å–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤
    if [[ -f "$PROJECTS_FILE" ]]; then
        sed -i "/^${SELECTED_PROJECT}|/d" "$PROJECTS_FILE"
    fi
    
    # –£–¥–∞–ª—è–µ–º –∏–∑ /etc/hosts (WSL)
    if grep -q "127.0.0.1.*${SELECTED_DOMAIN}" /etc/hosts 2>/dev/null; then
        sudo sed -i "/127.0.0.1.*${SELECTED_DOMAIN}/d" /etc/hosts 2>/dev/null || true
    fi
    
    # –£–¥–∞–ª—è–µ–º –¥–æ–º–µ–Ω –∏–∑ Windows hosts —Ñ–∞–π–ª–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    WIN_HOSTS="/mnt/c/Windows/System32/drivers/etc/hosts"
    
    if [[ -f "$WIN_HOSTS" ]]; then
        if grep -q "127.0.0.1.*${SELECTED_DOMAIN}" "$WIN_HOSTS" 2>/dev/null; then
            echo ""
            echo -e "${YELLOW}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
            echo -e "${BLUE}üîß –£–¥–∞–ª—è—é –¥–æ–º–µ–Ω ${SELECTED_DOMAIN} –∏–∑ Windows hosts...${NC}"
            echo -e "${YELLOW}–°–µ–π—á–∞—Å –ø–æ—è–≤–∏—Ç—Å—è –æ–∫–Ω–æ UAC - –Ω–∞–∂–º–∏—Ç–µ '–î–∞'${NC}"
            echo -e "${YELLOW}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
            sleep 2
            
            # –ü—ã—Ç–∞–µ–º—Å—è —É–¥–∞–ª–∏—Ç—å —á–µ—Ä–µ–∑ PowerShell —Å –ø—Ä–∞–≤–∞–º–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
            powershell.exe -Command "Start-Process powershell -Verb RunAs -ArgumentList '-NoProfile -Command \"(Get-Content C:\\Windows\\System32\\drivers\\etc\\hosts) -notmatch ''${SELECTED_DOMAIN}'' | Set-Content C:\\Windows\\System32\\drivers\\etc\\hosts\"' -Wait" 2>/dev/null
            if [[ $? -eq 0 ]]; then
                echo -e "${GREEN}‚úÖ –î–æ–º–µ–Ω ${SELECTED_DOMAIN} —É–¥–∞–ª—ë–Ω –∏–∑ Windows hosts${NC}"
            else
                echo -e "${YELLOW}‚ö† –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏${NC}"
                echo -e "${BLUE}–£–¥–∞–ª–∏—Ç–µ –≤—Ä—É—á–Ω—É—é –∏–∑ C:\\Windows\\System32\\drivers\\etc\\hosts —Å—Ç—Ä–æ–∫—É:${NC}"
                echo -e "   ${GREEN}127.0.0.1 ${SELECTED_DOMAIN}${NC}"
            fi
        else
            echo -e "${GREEN}‚úÖ –î–æ–º–µ–Ω ${SELECTED_DOMAIN} —É–∂–µ —É–¥–∞–ª—ë–Ω –∏–∑ Windows hosts${NC}"
        fi
    fi
    
    echo ""
    echo -e "${GREEN}‚úÖ –ü—Ä–æ–µ–∫—Ç '${SELECTED_PROJECT}' —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª—ë–Ω${NC}"
}

# –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
main_menu() {
    while true; do
        print_header
        echo "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
        echo ""
        echo "  1) –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç"
        echo "  2) –°–ø–∏—Å–æ–∫ –ø—Ä–æ–µ–∫—Ç–æ–≤"
        echo "  3) –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–µ–∫—Ç"
        echo "  4) –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç"
        echo "  5) –£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç"
        echo "  6) –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ–µ–∫—Ç –≤ VS Code"
        echo "  7) –û—Ç–∫—Ä—ã—Ç—å —Å–∞–π—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ"
        echo "  8) –û—Ç–∫—Ä—ã—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞"
        echo "  0) –í—ã—Ö–æ–¥"
        echo ""
        read -p "–í–∞—à –≤—ã–±–æ—Ä: " choice
        echo ""
        
        case $choice in
            1) create_project ;;
            2) list_projects ;;
            3) start_project ;;
            4) stop_project ;;
            5) remove_project ;;
            6) open_in_vscode ;;
            7) open_in_browser ;;
            8) open_project_db ;;
            0) 
                echo -e "${BLUE}üëã –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!${NC}"
                exit 0
                ;;
            *) 
                echo -e "${RED}‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä${NC}"
                ;;
        esac
        
        echo ""
        read -p "–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è..."
        clear
    done
}

# –°–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ø—Ä–æ–µ–∫—Ç–æ–≤ –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
mkdir -p "$WWW_PATH"

# –ü–æ–¥–∫–ª—é—á–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
if [[ -f "/usr/local/bin/db-tools.sh" ]]; then
    source /usr/local/bin/db-tools.sh
fi

# –ó–∞–ø—É—Å–∫–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
clear
main_menu
